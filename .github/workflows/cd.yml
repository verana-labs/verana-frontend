name: Continuous Deployment

env:
  IMAGE_NAME: verana-front
  DH_USERNAME: ${{ secrets.DOCKER_HUB_LOGIN }}
  DH_TOKEN: ${{ secrets.DOCKER_HUB_PWD }}
  KUBECONFIG: ${{ secrets.OVH_KUBECONFIG }}
  VERANA_DEPLOY_PATH: verana-deploy
  CLUSTER_NODE: cluster-utc-node-07efe5
  VERANA_ENV: testnet
  VERANA_CHAIN_ID: vna-testnet-1

on:
  push:
    branches:
      - main    
    tags:
      - '*'
  workflow_dispatch:

jobs:
  publish_image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DH_USERNAME }}
          password: ${{ env.DH_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_HUB_LOGIN }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

      - name: Checkout deployment manifests
        uses: actions/checkout@v4
        with:
          repository: verana-labs/verana-deploy
          ref: main
          path: ${{ env.VERANA_DEPLOY_PATH }}

      - name: Set up Kubernetes
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.9'

      - name: Deploy to OVH
        run: |
          echo "$KUBECONFIG" > k8s_config
          export KUBECONFIG=k8s_config

          export DEPLOYMENT_NAME=verana-${{ env.VERANA_ENV }}-frontend-app-deployment
          export NEXT_PUBLIC_PORT=3000
          export NEXT_PUBLIC_BASE_URL=http://localhost:2904
          export NEXT_PUBLIC_VERANA_CHAIN_ID=${{ env.VERANA_CHAIN_ID }}
          export NEXT_PUBLIC_VERANA_CHAIN_NAME=VeranaTestnet1
          export NEXT_PUBLIC_VERANA_RPC_ENDPOINT=https://rpc.${{ env.VERANA_ENV }}.verana.network
          export NEXT_PUBLIC_VERANA_REST_ENDPOINT=https://api.${{ env.VERANA_ENV }}.verana.network
          export NEXT_PUBLIC_VERANA_REST_ENDPOINT_GET_ACCOUNT=https://api.${{ env.VERANA_ENV }}.verana.network/verana/td/v1/get
          export NEXT_PUBLIC_VERANA_REST_ENDPOINT_LIST_DID=https://api.${{ env.VERANA_ENV }}.verana.network/verana/dd/v1/list
          export NEXT_PUBLIC_VERANA_REST_ENDPOINT_GET_DID=https://api.${{ env.VERANA_ENV }}.verana.network/verana/dd/v1/get
          export DH_USERNAME=$DH_USERNAME
          export IMAGE_NAME=$IMAGE_NAME
          export IMAGE_TAG=$IMAGE_TAG

          cd ${{ env.VERANA_DEPLOY_PATH }}
          kubectl delete -n ${{ env.VERANA_CHAIN_ID }} deployment $DEPLOYMENT_NAME || true
          envsubst < kubernetes/verana-frontend-deployment.yaml > substituted-deployment.yaml
          kubectl apply -f substituted-deployment.yaml --namespace=${{ env.VERANA_CHAIN_ID }}

name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'testnet'
        type: choice
        options:
          - testnet
          - betanet

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.OVH_KUBECONFIG }}

      - name: Set up Helm
        uses: azure/setup-helm@v3

      - name: Set deployment variables
        id: vars
        run: |
          if [ "${{ inputs.environment }}" = "betanet" ]; then
            echo "namespace=vna-betanet-1" >> $GITHUB_OUTPUT
            echo "values_file=./charts/values-betanet.yaml" >> $GITHUB_OUTPUT
          else
            echo "namespace=vna-testnet-1" >> $GITHUB_OUTPUT
            echo "values_file=./charts/values.yaml" >> $GITHUB_OUTPUT
          fi

      - name: Deploy (Helm upgrade --install)
        env:
          NAMESPACE: ${{ steps.vars.outputs.namespace }}
          VALUES_FILE: ${{ steps.vars.outputs.values_file }}
        run: |
          helm upgrade --install verana-frontend ./charts \
            -f "$VALUES_FILE" \
            -n "$NAMESPACE" \
            --create-namespace \
            --wait \
            --atomic \
            --timeout 20m
